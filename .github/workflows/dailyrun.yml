name: Daily Run

on:
  push:
    branches:
      - "master"
  schedule:
    - cron: "15 16 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-main:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'mrkb0827'
    env:
      USER1_COOKIE: ${{ secrets.USER1_COOKIE }}
      USER2_COOKIE: ${{ secrets.USER2_COOKIE }}
      USER1_STOKEN: ${{ secrets.USER1_STOKEN }}
      USER2_STOKEN: ${{ secrets.USER2_STOKEN }}
      USER1_MID: ${{ secrets.USER1_MID }}
      USER2_MID: ${{ secrets.USER2_MID }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate user config files
        shell: bash
        run: |
          python - << 'EOF'
          import os, copy, configparser, yaml
          ini_path = "config/user.ini"
          parser = configparser.ConfigParser()
          parser.optionxform = str
          parser.read(ini_path, encoding="utf-8")
          with open("config/config.yaml.example", "r", encoding="utf-8") as f:
              template = yaml.safe_load(f)
          for section in parser.sections():
              cfg = copy.deepcopy(template)
              for key in ["cookie", "stoken", "mid"]:
                  env_var = f"{section.upper()}_{key.upper()}"
                  value = str(os.environ.get(env_var, "")).replace("\n", "").strip()
                  cfg["account"][key] = value
              for game, flag in parser[section].items():
                  if game in cfg.get("games", {}).get("cn", {}):
                     cfg["games"]["cn"][game]["checkin"] = (flag.strip() == "1")
              output_path = f"config/config_{section}.yaml"
              with open(output_path, "w", encoding="utf-8") as out_f:
                  yaml.dump(cfg, out_f, allow_unicode=True, sort_keys=False)
              print(f"Generated {output_path}")
          EOF

      - name: Run main_multi.py
        run: python main_multi.py

      - name: Auto Keepalive
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          last_commit_date=$(git log -1 --format=%ct)
          now=$(date +%s)
          days_diff=$(( ($now - $last_commit_date) / 86400 ))
          
          echo "Days since last commit: $days_diff"
          
          if [ $days_diff -gt 50 ]; then
            echo "No activity for 50 days. Committing to keep workflow alive..."
            git commit --allow-empty -m "Automated keepalive commit [skip ci]"
            git push
          else
            echo "Repository is active. No keepalive commit needed."
          fi
